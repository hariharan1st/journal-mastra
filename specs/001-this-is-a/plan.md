# Implementation Plan: Multi-role Telegram Journaling Assistant

**Branch**: `[001-this-is-a]` | **Date**: 2025-10-04 | **Spec**: [`specs/001-this-is-a/spec.md`](../001-this-is-a/spec.md)
**Input**: Feature specification from `/specs/001-this-is-a/spec.md`

## Summary

Admin caregivers publish a single global tracking catalogue that drives dynamic PostgreSQL tables, reminders, and analytics across two Mastra-powered Telegram bots. The platform parses caregiver instructions into schema updates, records user activities against category-specific tables, answers historical questions with analytics insights, and references uploaded documents while maintaining HIPAA/GDPR audit trails.

## Technical Context

**Language/Version**: TypeScript 5.9 on Node.js 20.9
**Primary Dependencies**: `@mastra/core`, `@mastra/memory`, `@mastra/loggers`, `@ai-sdk/anthropic`, `ollama-ai-provider-v2`, `zod`, `pg`, `pgvector`
**Storage**: PostgreSQL 15+ (primary data + embeddings), encrypted filesystem for document originals, LibSQL (existing) for Mastra telemetry
**Validation Approach**: Manual validation matrix (see `manual-validation.md`) supplemented by Mastra telemetry smoke checks
**Target Platform**: Linux server deployment with dual Telegram bots (admin + user)
**Project Type**: Single backend service with multi-agent orchestration
**Performance Goals**: <3s response to chat queries, reminder delivery success ≥ 99%, platform uptime ≥ 99.5%
**Constraints**: Enforce HIPAA/GDPR policies, additive-only schema evolution, row-level security on journal data, audit logging for all DDL/DML tool executions
**Scale/Scope**: MVP supports ~500 concurrent users with headroom to scale to 5k daily interactions in quarter one

## Constitution Check

_GATE: Must pass before Phase 0 research. Re-check after Phase 1 design._

- **Modular Architecture Mandate**: Introduce discrete agents (`adminCatalogueAgent`, `journalInteractionAgent`), workflows (`journalOrchestratorWorkflow`, `reminderScheduler`), and tools with well-defined contracts under `src/mastra/`.
- **Reusable Building Blocks First**: Reuse Mastra runtime, logging, Ollama integrations, and centralize Postgres/Zod helpers in shared modules to prevent duplication.
- **Readable Code Standard**: Design enforces typed contracts, small functions, and inline documentation for schema orchestration, auditing, and analytics.
- **Security by Design**: All prompts pass through validation; tool layer mediates DDL/DML with audit events, secrets managed via `.env` with no hard-coded credentials.
- **Scalable Efficiency Focus**: Postgres pooling with `pg`, batched embedding generation, and asynchronous reminder scheduling keep latency predictable.

**Gate Verdicts**: Initial PASS (Phase 0) and Post-Design PASS (Phase 1) — no constitutional deviations.

## Project Structure

### Documentation (this feature)

```
specs/001-this-is-a/
├── plan.md               # Implementation plan (this file)
├── research.md           # Phase 0 decisions & rationale
├── data-model.md         # Phase 1 entity catalogue
├── quickstart.md         # Environment & runbook instructions
├── manual-validation.md  # Evidence capture plan
├── AGENTS.md             # Agent briefs & guardrails
├── contracts/
│   ├── admin-catalogue-contract.md
│   └── journal-writer-contract.md
└── tasks.md              # Generated by /tasks command (future)
```

### Source Code (repository root)

```
src/
└── mastra/
    ├── index.ts
    ├── agents/
    │   ├── admin-catalogue-agent.ts
    │   ├── journal-interaction-agent.ts
    │   └── weather-agent.ts              # legacy sample (to retire later)
    ├── workflows/
    │   ├── journal-orchestrator-workflow.ts
    │   ├── reminder-scheduler.ts
    │   └── weather-workflow.ts           # legacy sample
    ├── tools/
    │   ├── catalogue-schema-tool.ts
    │   ├── journal-writer-tool.ts
    │   ├── document-ingestion-tool.ts
    │   └── analytics-insights-tool.ts
    ├── models/
    │   ├── postgres.ts                   # pooled client + helpers
    │   ├── embeddings.ts                 # Ollama embedding bridge
    │   └── ollama.ts                     # existing model provider
    └── shared/
        ├── schema-parsers.ts             # Zod schemas & field inference
        └── telemetry.ts                  # logging/metrics helpers

docs/
├── feature-guides/
│   └── 001-this-is-a.md                  # post-implementation write-up
└── validations/
    └── 001-this-is-a/
        ├── README.md
        └── evidence/*                    # transcripts, screenshots, SQL dumps
```

**Structure Decision**: Extend existing Mastra backend by layering new admin/user agents, workflows, and Postgres tooling. Legacy weather demo remains unaffected, preserving modular boundaries per Constitution Principle I.

## Phase 0: Outline & Research

- Consolidated unknowns into `research.md`, covering dynamic schema orchestration, agent split, tool roster, document ingestion, and compliance logging.
- Selected PostgreSQL with additive DDL strategy and immutable `audit_events` log to satisfy HIPAA/GDPR.
- Confirmed two-agent topology to mirror separate Telegram bots and avoid prompt bloat.
- Standardized tool contracts for schema changes and journal writes, ensuring deterministic, auditable operations.
- **Status**: Complete — no outstanding clarifications.

## Phase 1: Design & Contracts

- `data-model.md` documents core relational schema (catalogue, dynamic journal tables, reminders, documents, audit events) and RLS/audit considerations.
- `/contracts/` defines TypeScript request/response shapes for `catalogueSchemaTool` and `journalWriterTool`, including error codes and idempotency requirements.
- `AGENTS.md` outlines admin vs. user agent briefs, guardrails, and shared workflow telemetry expectations.
- `quickstart.md` delivers environment bootstrap (Node 20, Postgres + pgvector, Telegram tokens, Ollama) and dev workflows.
- `manual-validation.md` enumerates seven validation scenarios (MV-01…MV-07) aligned with acceptance criteria and compliance checks.
- `.specify/scripts/bash/update-agent-context.sh copilot` executed to sync global instructions (rerun after any major plan edits).
- **Status**: Complete — design artifacts ready for task generation.

## Phase 2: Task Planning Approach

_This section describes what the /tasks command will do — DO NOT execute during /plan._

- Load `.specify/templates/tasks-template.md` and map deliverables from `data-model.md`, `contracts/`, `AGENTS.md`, `quickstart.md`, and `manual-validation.md`.
- Generate ordered tasks covering configuration scaffolding, Postgres client + migrations, admin catalogue pipeline, journal logging, reminders, document ingestion, analytics insights, audit logging, and manual validation evidence.
- Label parallelizable tracks (e.g., document ingestion vs. reminder scheduler) with `[P]` for future execution planning.
- Include security/performance work items: RLS enforcement, consent gating, telemetry dashboards.
- Expected output: ~20 tasks with explicit dependencies and evidence capture notes in `tasks.md`.

## Phase 3+: Future Implementation

- **Phase 3**: Run `/tasks` to materialize task list.
- **Phase 4**: Implement tasks respecting modular boundaries and compliance guardrails.
- **Phase 5**: Execute manual validation matrix, archive evidence in `docs/validations/001-this-is-a/`.

## Complexity Tracking

_No constitutional deviations identified; table not required._

## Progress Tracking

- [x] Phase 0: Research complete (/plan command)
- [x] Phase 1: Design complete (/plan command)
- [ ] Phase 2: Task planning complete (/plan command — describe approach only)
- [x] Manual validation plan documented
- [ ] Phase 3: Tasks generated (/tasks command)
- [ ] Phase 4: Implementation complete
- [ ] Phase 5: Validation passed

**Gate Status** (Constitution v1.0.0):

- [x] Initial Constitution Check: PASS
- [x] Post-Design Constitution Check: PASS
- [x] All NEEDS CLARIFICATION resolved
- [ ] Complexity deviations documented (N/A)
